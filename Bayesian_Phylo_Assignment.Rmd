---
title: "Computing Assignment â€“ Bayesian phylogenetics and epidemiology"
output:
  html_document: default
  pdf_document: default
---

```{r setup, message=FALSE, warning=FALSE, results='hide'}
# List of required packages
required_packages <- c(
  "rmarkdown", "tinytex", "tidyverse", "ggtree", 
  "ggridges", "treeio", "coda", "cols4all")

# Install missing packages by comparing against the currently installed packages
missing_packages <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(missing_packages)) {
  install.packages(missing_packages)
}
#loads all the packages by applying the library function to each
lapply(required_packages, library, character.only = TRUE)
```

Candidate Number: 1073601

**Question 1**

From the trees produced in the R Markdown file propose how many independent CHIKV introductions into Kassala sparked and sustained the 2018 outbreak, and their time of occurrence. How much earlier from the onset of the current outbreak is this estimated to be, and what does this imply? Use tree visualisations and the distribution of relevant parameter estimates to explain your answer.

```{r}
# Load the MCC tree
beast_file <- ("MCC_trees/MCC_CHIKV_IndianOcean.tree")
beast_tree <- treeio::read.beast(beast_file)

# Plots a tree showing the latest possible Kassala MRCA 
ggtree(beast_tree, aes(color = outbreak), mrsd="2018-10-16") + theme_tree2() +
  scale_x_continuous(breaks = c(2002, 2004, 2006, 2008, 2010, 2012, 2014, 2016, 2018),
                     minor_breaks = seq(2004, 2019, 1)) +
  geom_point2(aes(subset = (node == 255)), shape = 21, size = 3, fill = 'darkblue') +
  scale_color_discrete_c4a_cat("friendly7") +
  theme(panel.grid.major = element_line(color = "black", size = .1),
        panel.grid.minor = element_line(color = "grey", size = .1),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank())
#Scale bars are added, and the outbreaks are represented using colour-blind friendly visuals
```

As you can see from the above graph, all the Kassala nodes are monophyletic and branch from an individual MRCA that is inferred to have been within Kassala. This suggests that only one independent CHIKV introduction caused the 2018 outbreak. The estimated MRCA sets a limit for the most recent point at which the Kassala cases could have begun spreading, but there may have been earlier transmission events that attached to the tree at the long basal branch that were not sampled. Taking this into account, to estimate a more accurate date at which the Kassala outbreak began, we can use the posterior distribution of the "Age of Kassala Outbreak MRCA" parameter. 

```{r}
#Creating a data frame of the parameters with the burn-in removed
beast_log <- read.csv("MCMC_log_files/CHIKV_IndianOcean_BEAST_output_log.csv")
beast_log_burnin <- beast_log[floor(nrow(beast_log) * 0.1):nrow(beast_log),]


#Generating a 95% HPD of the Kassala MRCA
hpd <- paste0(round(HPDinterval(as.mcmc(beast_log_burnin$age.Kassala_outbreak.))[1], 2),
              ", ",
              round(HPDinterval(as.mcmc(beast_log_burnin$age.Kassala_outbreak.))[2], 2))

beast_log_burnin |>
  select(age.Kassala_outbreak.) |>
  pivot_longer(cols = c("age.Kassala_outbreak."), names_to = "clade") |>
  ggplot(aes(x = value, y = clade, fill = factor(stat(quantile)))) +
  stat_density_ridges(geom = "density_ridges_gradient",
                      calc_ecdf = TRUE,
                      quantiles = c(0.025, 0.975),
                      alpha = 0.2) +
  scale_fill_manual(name = "Probability",
                    values = c("#882255", "#88CCEE", "#882255"),
                    labels = c("Lower 2.5% PD", "95% HPD", "Upper 2.5% PD")) +
  scale_y_discrete(expand = expansion(add = c(.1, 2.5))) +
  annotate("text", x = 2017, y = 2, label = hpd) +
  theme_classic() + theme(axis.title.y = element_blank(),
                          axis.text.y = element_blank(),
                          axis.ticks.y = element_blank())
```
From this 95% HPD we can see that the estimated date of the Kassala MRCA is somewhere between April 2016 and May 2017, with January 2017 being the most probable point at which CHIKV began circulating (given the current set of sampled viral sequences). Of course, this is almost a year and a half before the current outbreak was identified. 
july, outbreak, oct, samples taken
spreading before sampling taken - since 2017? 
someone may have been a long term asymptomatic carrier